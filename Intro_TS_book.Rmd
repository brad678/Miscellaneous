
---
title: "Intoductory Time Series in R"
output: 
  html_document: 
    smart: no
---


http://www.maths.adelaide.edu.au/andrew.metcalfe/



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### A flying start: Air passenger bookings

```{r}

data(AirPassengers)
AP <- AirPassengers
AP

```

```{r}
class(AP)
start(AP)
end(AP)
frequency(AP)
summary(AP)
```


```{r}
plot(AP)

# To get clear view of trend, the seasonal effect can be removed by aggr the data to annual level
# aggr is "sum"
# Default is "nfrequency = 1" which will split the year to one part. Total 12 yrs = 12 values
# If we give "nfrequency = 2", it will split into 2 entries per year. Total 12 yrs = 24 values
plot(aggregate(AP),main='View of Trend-Aggregated annual series') 

# A summary of the values for each season can be viewed using a boxplot, with the cycle function being used to extract the seasons for each item of data.

cycle(AP)

boxplot(AP ~ cycle(AP),main='View of Seasonality-Boxplot of seasonal values')



```


### Unemployment: Maine

```{r}
Maine.month <- read.table('Maine.dat', header = TRUE)
Maine.month.ts <- ts(Maine.month,start = c(1996,1),frequency = 12)
Maine.month.ts

```


```{r}
#AGGR "mean"
Maine.annual.ts <- aggregate(Maine.month.ts)/12

#layout(1:2)
plot(Maine.month.ts, ylab = "unemployed (%)",main='Unemployment over the years')
plot(Maine.annual.ts, ylab = "unemployed (%)",main='Trend of unemployment')

```


```{r}
Maine.Feb <- window(Maine.month.ts, start = c(1996,2), freq = TRUE)
Maine.Aug <- window(Maine.month.ts, start = c(1996,8), freq = TRUE)
Feb.ratio <- mean(Maine.Feb) / mean(Maine.month.ts);Feb.ratio
Aug.ratio <- mean(Maine.Aug) / mean(Maine.month.ts);Aug.ratio


```

```{r}
monthplot(Maine.month.ts)
boxplot(Maine.month.ts~cycle(Maine.month.ts),main='seasonal values')

```

### comparision of maine to US

```{r}

US.month <- read.table('USunemp.dat', header = T)
US.month.ts <- ts(US.month,start=c(1996,1),frequency = 12)
US.month.ts

plot(US.month.ts)

```

- The decrease in the unemployment rate around the millennium is common to Maine and the United States as a whole, but Maine does not seem to be sharing the current US decrease in unemployment.



### Multiple time series: Electricity, beer and chocolate data

```{r}

CBE <- read.table('cbe.dat', header = T)

Elec.ts <- ts(CBE[, 3], start = 1958, freq = 12)
Beer.ts <- ts(CBE[, 2], start = 1958, freq = 12)
Choc.ts <- ts(CBE[, 1], start = 1958, freq = 12)

Elec.ts


```


```{r}
# You can use plot with cbind to plot several series on one figure

plot(cbind(Elec.ts,Beer.ts,Choc.ts))


```


```{r}
#intersect bet 2 time series

AP.elec <- ts.intersect(Elec.ts,AP)
AP.elec

class(AP.elec)


```


```{r}

plot(AP.elec)

```

```{r}

#scatter plot

plot(as.vector(AP.elec[,2]),as.vector(AP.elec[,1]),xlab = "Air passengers",ylab="Electricity production")
#abline(lsfit(as.vector(AP.elec[,2]),as.vector(AP.elec[,1])))
abline(reg=lm(as.vector(AP.elec[,1]) ~ as.vector(AP.elec[,2])))

cor(AP.elec[,1], AP.elec[,2])

```


### Quarterly exchange rate: GBP to NZ dollar

```{r}

Z <- read.table("pounds_nz.dat", header = T)

Z.ts <- ts(Z, st = 1991, fr = 4)

Z.ts

```

```{r}
plot(Z.ts)

```

```{r}

Z.92.96 <- window(Z.ts, start = c(1992, 1), end = c(1996, 1))
Z.96.98 <- window(Z.ts, start = c(1996, 1), end = c(1998, 1))
plot(Z.92.96, ylab = "Exchange rate in $NZ/pound", xlab = "Time (years)" )
plot(Z.96.98, ylab = "Exchange rate in $NZ/pound", xlab = "Time (years)" )

```


### Global temperature series

```{r}
#Global <- read.table('global.dat',header = TRUE)
Global <- scan('global.dat')
Global.ts <- ts(Global,st=c(1856,1),frequency = 12)
Global.ts

```

```{r}
plot(Global.ts)

plot(aggregate(Global.ts,FUN='mean'))

```


```{r}

New.series <- window(Global.ts,start=c(1970,1),end=c(2005,12))
New.time <- time(New.series)

plot(New.series)
abline(reg=lm(New.series~New.time))

```

### Decomposition in R - centre moving average

```{r}

#centre moving average

plot(decompose(Elec.ts)) # additive

Elec.decom <- decompose(Elec.ts, type = "mult")
plot(Elec.decom) # multiplicative


# superposition of multiplicative seasonal effect on trend
Trend <- Elec.decom$trend
Seasonal <- Elec.decom$seasonal
ts.plot(cbind(Trend, Trend * Seasonal), lty = 1:2, main = 'superposition of multiplicative seasonal effect on trend')

```


### Decomposition in R - seasonal trend decomposition 

```{r}

#stl

plot(stl(Elec.ts,s.window = 'periodic'))

```


### exercise 1.7

```{r}

plot(Beer.ts,main="Time series of beer data")
plot(aggregate(Beer.ts,FUN = mean),main="Trend in beer data")
boxplot(Beer.ts ~ cycle(Beer.ts),main="sesonality in beer data")

plot(decompose(Beer.ts))
Beer.decom <- decompose(Beer.ts,type = "mult")
plot(Beer.decom)
ts.plot(cbind(Beer.decom$trend,Beer.decom$trend*Beer.decom$seasonal),main="superposition of multiplicative seasonal effect on trend")

```

### Auto correlation

```{r}

wave.dat <- read.table ("wave.dat", header=T)

plot(ts(wave.dat$waveht)) #since there is no trend , no seasonal period
plot(ts(wave.dat$waveht[1:60])) #since there is no trend , no seasonal period


```

```{r}

acf(wave.dat$waveht)
acf(wave.dat$waveht)$acf[1] #auto corr at lag 1
acf(wave.dat$waveht)$acf[2] #auto corr at lag 2


```


```{r}
acf(wave.dat$waveht, type = c("covariance"))$acf[2]
```


```{r}
data(AirPassengers)
AP <- AirPassengers
AP.decom <- decompose(AP, "multiplicative")
plot(ts(AP.decom$random[7:138]))
acf(AP.decom$random[7:138])


```

```{r}

sd(AP[7:138])
sd(AP[7:138] - AP.decom$trend[7:138])
sd(AP.decom$random[7:138])

```


###

```{r}

Build.dat <- read.table('ApprovActiv.dat', header=T) 
attach(Build.dat)
App.ts <- ts(Approvals, start = c(1996,1), freq=4)
Act.ts <- ts(Activity, start = c(1996,1), freq=4)
ts.plot(App.ts, Act.ts, lty = c(1,3))


```

```{r}

acf(ts.union(App.ts, Act.ts))

```


```{r}

app.ran <- decompose(App.ts)$random
app.ran.ts <- window (app.ran, start = c(1996, 3) )
act.ran <- decompose (Act.ts)$random
act.ran.ts <- window (act.ran, start = c(1996, 3) )
acf (ts.union(app.ran.ts, act.ran.ts),na.action = na.pass)
ccf (app.ran.ts, act.ran.ts,na.action = na.pass)

print(acf (ts.union(app.ran.ts, act.ran.ts),na.action = na.pass))

```



### Holt winters - Exponential smoothing

```{r}
Motor.dat <- read.table("motororg.dat", header = T); attach(Motor.dat)
Comp.ts <- ts(complaints, start = c(1996, 1), freq = 12)
plot(Comp.ts, xlab = "Time / months", ylab = "Complaints")

```


```{r}
Comp.hw1 <- HoltWinters(Comp.ts, beta = FALSE, gamma = FALSE) ; Comp.hw1
plot(Comp.hw1)

```

```{r}
Comp.hw1$SSE
```


### Holtwinter multiplicative

```{r}
wine.dat <- read.table("wine.dat", header = T) ; attach (wine.dat)
sweetw.ts <- ts(sweetw, start = c(1980,1), freq = 12)
plot(sweetw.ts, xlab= "Time (months)", ylab = "sales (1000 litres)")


```



```{r}
sweetw.hw <- HoltWinters (sweetw.ts, seasonal = "mult")
sweetw.hw ; sweetw.hw$coef ; sweetw.hw$SSE

```

```{r}
sqrt(sweetw.hw$SSE/length(sweetw))

sd(sweetw)

```

```{r}
plot (sweetw.hw)
plot (sweetw.hw$fitted)
```

```{r}

AP.hw <- HoltWinters(AP, seasonal = "mult")
plot(AP.hw)



```


```{r}
AP.predict <- predict(AP.hw, n.ahead = 4 * 12)
ts.plot(AP, AP.predict, lty = 1:2)

```


```{r}
set.seed(1)
w <- rnorm(100)
plot(w, type = "l")


x <- seq(-3,3, length = 1000)
hist(rnorm(100), prob = T); points(x, dnorm(x), type = "l")


```

### random walk demonstration


```{r}

x <- w <- rnorm(1000)
for (t in 2:1000) x[t] <- x[t - 1] + w[t]
plot(x, type = "l")

acf(x)

acf(diff(x))

```


```{r}

plot(Z.ts)
acf(diff(Z.ts))

Z.hw <- HoltWinters(Z.ts, alpha = 0.5, gamma = 0)

acf(resid(Z.hw))

```


### Random walk with drift


```{r}

www <- "http://www.maths.adelaide.edu.au/andrew.metcalfe/Data/HP.txt"
HP.dat <- read.table(www, header = T) ; attach(HP.dat)
plot (as.ts(Price))
DP <- diff(Price) ; plot (as.ts(DP)) ; acf (DP)
mean(DP) + c(-2, 2) * sd(DP)/sqrt(length(DP))

```


